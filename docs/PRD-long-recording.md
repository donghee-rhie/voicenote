# PRD: 장시간 녹음 지원 (120분)

## 문서 정보
- **버전**: 1.0
- **작성일**: 2026-02-07
- **상태**: Draft

---

## 1. 개요

### 1.1 목적
VoiceNote 앱에서 최대 120분(2시간)까지 안정적인 녹음 및 전사를 지원하여 장시간 회의, 강의, 인터뷰 등의 사용 사례를 커버한다.

### 1.2 배경
- 현재 최대 녹음 시간: 10분
- 사용자 요구: 장시간 회의/강의 녹음 필요
- API 제한: Groq 100MB, ElevenLabs 화자분리 8분

### 1.3 범위
- 녹음 시간 확장 (60분)
- 청크 분할 전사
- 스트리밍 저장
- 진행률 표시
- 에러 복구

---

## 2. 기능 요구사항

### 2.1 청크 분할 처리 (Chunked Transcription)

#### 2.1.1 오디오 분할
| 항목 | 요구사항 |
|------|----------|
| **청크 크기** | 최대 7분 (420초) - 화자분리 8분 제한 고려 |
| **오버랩** | 3초 - 문장 중간 끊김 방지 |
| **분할 시점** | 녹음 완료 후 전사 전 |

#### 2.1.2 분할 로직
```
전체 오디오 (예: 120분)
    ↓
[7분] × 17개 + [1분]
    ↓ (3초씩 오버랩)
총 18개 청크
```

#### 2.1.3 결과 병합
- 각 청크의 전사 결과를 시간순 병합
- 오버랩 구간 중복 텍스트 제거 (유사도 기반)
- 타임스탬프 재계산

#### Task 목록
- [ ] **T1.1** `AudioChunker` 클래스 구현
  - 입력: AudioBlob, ChunkConfig
  - 출력: Blob[]
  - 위치: `src/main/services/audio-chunker.ts`

- [ ] **T1.2** 청크 병합 로직 구현
  - 오버랩 중복 제거 알고리즘
  - 타임스탬프 오프셋 계산
  - 위치: `src/main/services/transcription-merger.ts`

- [ ] **T1.3** 전사 핸들러 수정
  - 청크 순차 처리
  - 진행률 이벤트 발송
  - 위치: `src/main/ipc/transcription-handler.ts`

---

### 2.2 스트리밍 저장 (Streaming Save)

#### 2.2.1 요구사항
| 항목 | 요구사항 |
|------|----------|
| **저장 간격** | 30초마다 |
| **저장 위치** | `userData/temp/recordings/` |
| **파일 형식** | WebM (Opus) |
| **보존 기간** | 전사 완료 후 삭제 (또는 24시간) |

#### 2.2.2 동작 방식
```
녹음 시작
    ↓
[30초] → chunk_001.webm 저장
[60초] → chunk_002.webm 저장
[90초] → chunk_003.webm 저장
    ...
    ↓
녹음 종료
    ↓
전체 병합 또는 개별 청크 유지
```

#### 2.2.3 크래시 복구
- 앱 재시작 시 미완료 녹음 감지
- 저장된 청크로부터 복구 옵션 제공

#### Task 목록
- [ ] **T2.1** `StreamingSaver` 클래스 구현
  - MediaRecorder 30초 간격 데이터 캡처
  - 청크 파일 저장
  - 위치: `src/renderer/hooks/useStreamingRecording.ts`

- [ ] **T2.2** 청크 파일 관리
  - 저장/삭제 로직
  - 디스크 공간 확인
  - 위치: `src/main/services/chunk-file-manager.ts`

- [ ] **T2.3** 복구 UI 구현
  - 미완료 녹음 감지
  - 복구 다이얼로그
  - 위치: `src/renderer/components/RecoveryDialog.tsx`

---

### 2.3 비트레이트 최적화

#### 2.3.1 검토 결과
청크 분할 처리 시 **적응형 비트레이트는 불필요**.

**이유**:
- 7분 청크 × 64kbps = ~3.3MB (Groq 100MB 한참 이내)
- 일정한 품질 유지가 더 중요
- 구현 복잡도 대비 이득 없음

#### 2.3.2 고정 비트레이트 설정
| 설정 | 값 |
|------|-----|
| **비트레이트** | 64 kbps |
| **샘플레이트** | 48000 Hz |
| **채널** | Mono |

#### Task 목록
- [ ] **T3.1** MediaRecorder 옵션 최적화
  - 비트레이트 64kbps 고정
  - 위치: `src/renderer/hooks/useRecording.ts`

---

### 2.4 진행률 표시 (Progress Indicator)

#### 2.4.1 표시 정보
| 단계 | 표시 내용 |
|------|----------|
| **녹음 중** | 경과 시간, 남은 시간 (최대 120분 기준) |
| **전사 중** | 현재 청크 / 전체 청크, 예상 남은 시간 |
| **정제 중** | 현재 섹션 / 전체 섹션, 예상 남은 시간 |

#### 2.4.2 UI 요소
```
┌─────────────────────────────────────────┐
│  전사 중... (3/9 청크)                   │
│  ████████░░░░░░░░░░░░░░░░░  33%         │
│  예상 남은 시간: 약 2분                  │
└─────────────────────────────────────────┘
```

#### Task 목록
- [ ] **T4.1** 진행률 상태 타입 정의
  - `ProcessingProgress` 인터페이스
  - 위치: `src/common/types/ipc.ts`

- [ ] **T4.2** 진행률 UI 컴포넌트
  - 프로그레스 바
  - 단계별 상태 표시
  - 위치: `src/renderer/components/ProcessingProgress.tsx`

- [ ] **T4.3** IPC 이벤트 연동
  - 메인 → 렌더러 진행률 전송
  - 위치: `src/main/ipc/transcription-handler.ts`

---

### 2.5 재시도 로직 (Retry Logic)

#### 2.5.1 재시도 정책
| 항목 | 값 |
|------|-----|
| **최대 재시도** | 3회 |
| **재시도 간격** | 2초 → 4초 → 8초 (지수 백오프) |
| **재시도 대상** | 네트워크 오류, 타임아웃, 5xx 에러 |
| **재시도 안함** | 인증 오류 (401), 파일 오류 (400) |

#### 2.5.2 청크 단위 재시도
- 실패한 청크만 재시도
- 성공한 청크는 캐시에 보관
- 전체 실패 시 사용자에게 부분 결과 제공 옵션

#### Task 목록
- [ ] **T5.1** `RetryHandler` 유틸리티
  - 지수 백오프 로직
  - 에러 타입별 재시도 판단
  - 위치: `src/main/services/retry-handler.ts`

- [ ] **T5.2** 전사 서비스에 재시도 적용
  - Groq STT 서비스
  - ElevenLabs STT 서비스
  - 위치: `src/main/services/groq-stt-service.ts`, `elevenlabs-stt-service.ts`

- [ ] **T5.3** 부분 실패 처리
  - 성공 청크 결과 저장
  - 실패 청크 표시
  - 위치: `src/renderer/components/PartialResultDialog.tsx`

---

### 2.6 정제 분할 처리 (Chunked Refinement)

#### 2.6.1 문제
- 60분 텍스트 ≈ 15,000~30,000 단어
- LLM 컨텍스트 제한: ~8,000 토큰 (입력+출력)

#### 2.6.2 분할 전략
| 항목 | 값 |
|------|-----|
| **청크 크기** | 최대 2,000 단어 |
| **분할 기준** | 문단/문장 경계 |
| **병합 방식** | 순차 연결 |

#### 2.6.3 요약 전략
```
[청크1 정제] [청크2 정제] ... [청크N 정제]
            ↓
         정제 텍스트 병합
            ↓
      전체 요약 생성 (별도 호출)
```

#### Task 목록
- [ ] **T6.1** `TextChunker` 유틸리티
  - 문장 경계 기준 분할
  - 단어 수 계산
  - 위치: `src/main/services/text-chunker.ts`

- [ ] **T6.2** 정제 서비스 수정
  - 청크 단위 정제
  - 결과 병합
  - 위치: `src/main/services/groq-refinement-service.ts`

- [ ] **T6.3** 전체 요약 생성
  - 병합된 정제 텍스트 기반
  - 별도 LLM 호출
  - 위치: `src/main/services/summary-service.ts`

---

### 2.7 설정 UI 확장

#### 2.7.1 녹음 시간 설정 확장
| 현재 | 변경 후 |
|------|---------|
| 60초 ~ 600초 | 60초 ~ 7,200초 (2시간) |

#### 2.7.2 새로운 설정 항목
- [ ] 자동 복구 활성화 (기본: ON)
- [ ] 청크 크기 (고급, 기본: 7분)

#### Task 목록
- [ ] **T7.1** 설정 범위 확장
  - `maxRecordingDuration` 범위 변경
  - 위치: `src/renderer/pages/SettingsPage.tsx`

- [ ] **T7.2** Prisma 스키마 업데이트 (필요시)
  - 새 설정 필드 추가
  - 위치: `prisma/schema.prisma`

---

## 3. 기술 설계

### 3.1 신규 파일 구조
```
src/
├── main/
│   └── services/
│       ├── audio-chunker.ts        # T1.1
│       ├── transcription-merger.ts # T1.2
│       ├── chunk-file-manager.ts   # T2.2
│       ├── retry-handler.ts        # T5.1
│       ├── text-chunker.ts         # T6.1
│       └── summary-service.ts      # T6.3
└── renderer/
    ├── hooks/
    │   └── useStreamingRecording.ts # T2.1
    └── components/
        ├── ProcessingProgress.tsx   # T4.2
        ├── RecoveryDialog.tsx       # T2.3
        └── PartialResultDialog.tsx  # T5.3
```

### 3.2 데이터 플로우
```
[녹음 시작]
    ↓
[30초마다 청크 저장] ←── 스트리밍 저장 (T2)
    ↓
[녹음 종료]
    ↓
[7분 단위 오디오 분할] ←── 청크 분할 (T1)
    ↓
[각 청크 전사 (순차)] ←── 재시도 로직 (T5)
    ↓                      진행률 표시 (T4)
[전사 결과 병합]
    ↓
[즉시 원문 붙여넣기]
    ↓
[2000단어 단위 정제] ←── 정제 분할 (T6)
    ↓
[전체 요약 생성]
    ↓
[완료 알림]
```

---

## 4. 구현 우선순위

### Phase 1: 핵심 기능 (필수)
| 우선순위 | Task | 설명 |
|----------|------|------|
| P0 | T1.1, T1.2, T1.3 | 청크 분할 전사 |
| P0 | T4.1, T4.2, T4.3 | 진행률 표시 |
| P0 | T7.1 | 설정 범위 확장 |

### Phase 2: 안정성 (중요)
| 우선순위 | Task | 설명 |
|----------|------|------|
| P1 | T5.1, T5.2 | 재시도 로직 |
| P1 | T6.1, T6.2, T6.3 | 정제 분할 |
| P1 | T3.1 | 비트레이트 최적화 |

### Phase 3: 복구 (권장)
| 우선순위 | Task | 설명 |
|----------|------|------|
| P2 | T2.1, T2.2, T2.3 | 스트리밍 저장 및 복구 |
| P2 | T5.3 | 부분 실패 처리 |

---

## 5. 테스트 계획

### 5.1 단위 테스트
- [ ] AudioChunker 분할 정확성
- [ ] TranscriptionMerger 병합 정확성
- [ ] RetryHandler 재시도 로직
- [ ] TextChunker 문장 경계 분할

### 5.2 통합 테스트
- [ ] 15분 녹음 전사 (3개 청크)
- [ ] 30분 녹음 전사 (5개 청크)
- [ ] 60분 녹음 전사 (9개 청크)
- [ ] 120분 녹음 전사 (18개 청크)

### 5.3 에러 케이스
- [ ] 중간 청크 전사 실패 시 재시도
- [ ] 전체 실패 시 부분 결과 표시
- [ ] 녹음 중 앱 크래시 복구

---

## 6. 성공 기준

| 항목 | 기준 |
|------|------|
| **녹음** | 120분 연속 녹음 안정적 동작 |
| **전사** | 120분 오디오 전사 성공률 95% 이상 |
| **정제** | 전체 텍스트 정제 및 요약 생성 |
| **복구** | 크래시 후 90% 이상 데이터 복구 |
| **UX** | 진행률 실시간 표시, 예상 시간 ±20% |

---

## 7. 일정 (예상)

| Phase | 소요 시간 |
|-------|----------|
| Phase 1 | 구현 필요 |
| Phase 2 | 구현 필요 |
| Phase 3 | 구현 필요 |

---

## 8. 리스크

| 리스크 | 영향 | 대응 |
|--------|------|------|
| API 응답 지연 | 전사 시간 증가 | 타임아웃 증가, 비동기 처리 |
| 메모리 부족 | 앱 크래시 | 스트리밍 저장으로 메모리 최소화 |
| 디스크 공간 부족 | 녹음 실패 | 사전 용량 확인, 경고 표시 |

---

## 부록: Task 체크리스트

### 청크 분할 처리
- [ ] T1.1 AudioChunker 클래스 구현
- [ ] T1.2 청크 병합 로직 구현
- [ ] T1.3 전사 핸들러 수정

### 스트리밍 저장
- [ ] T2.1 StreamingSaver 클래스 구현
- [ ] T2.2 청크 파일 관리
- [ ] T2.3 복구 UI 구현

### 비트레이트
- [ ] T3.1 MediaRecorder 옵션 최적화

### 진행률 표시
- [ ] T4.1 진행률 상태 타입 정의
- [ ] T4.2 진행률 UI 컴포넌트
- [ ] T4.3 IPC 이벤트 연동

### 재시도 로직
- [ ] T5.1 RetryHandler 유틸리티
- [ ] T5.2 전사 서비스에 재시도 적용
- [ ] T5.3 부분 실패 처리

### 정제 분할
- [ ] T6.1 TextChunker 유틸리티
- [ ] T6.2 정제 서비스 수정
- [ ] T6.3 전체 요약 생성

### 설정
- [ ] T7.1 설정 범위 확장
- [ ] T7.2 Prisma 스키마 업데이트 (필요시)
